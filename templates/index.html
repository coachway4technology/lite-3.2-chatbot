<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Lite Chatbot 4.0</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body class="dark">

<!-- HOME -->
<div id="home" class="home-screen">
    <h1>Lite Chatbot 4.0</h1>
    <p>Fast â€¢ Neon â€¢ Private</p>
    <button onclick="enterChat()">Start Chat</button>
</div>

<!-- CHAT -->
<div id="chatUI" class="chat-container hidden">
<h2>Lite Chatbot 5.2</h2>

<!-- PROFILE -->
<div class="profile">
    <input id="username" placeholder="Your name" onchange="updateUsername()">
    <select id="userHistory" onchange="selectUsername()"></select>
</div>

<!-- CONTROLS -->
<div class="controls">
    <input id="search" placeholder="Search chat" oninput="searchChat()">
    <button onclick="toggleTheme()">ğŸŒ™</button>
    <button onclick="importPDF()">ğŸ“¥ PDF</button>
    <button onclick="exportPDF()">ğŸ“¤ PDF</button>
    <button onclick="clearChat()">ğŸ—‘</button>
    <button onclick="openSettings()">âš™ï¸</button>
    <button onclick="openAdmin()">ğŸ› </button>
    <button onclick="openCommands()">â”</button>
</div>

<!-- CHAT BOX -->
<div id="chat-box"></div>

<!-- INPUT -->
<div class="input-area">
    <button onclick="startVoice()">ğŸ¤</button>
    <input id="message" placeholder="Type message">
    <button id="sendBtn" onclick="sendMessage()">Send</button>
</div>

<div class="footer">Tokens: <span id="tokens">0</span></div>

<input type="file" id="fileInput" accept="application/pdf" hidden>

</div>

<!-- SETTINGS -->
<div id="settings" class="modal hidden">
    <h3>Settings</h3>
    <input type="range" min="14" max="22" value="16" oninput="setTextSize(this.value)">
    <button onclick="closeSettings()">Close</button>
</div>

<!-- COMMANDS -->
<div id="commands" class="modal hidden">
    <h3>Commands</h3>
    <ul>
        <li>remember this</li>
        <li>save this</li>
        <li>my name is</li>
        <li>I like</li>
    </ul>
    <button onclick="closeCommands()">Close</button>
</div>

<!-- ADMIN -->
<div id="admin" class="modal hidden"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* ================= GLOBAL ================= */
const chatBox = document.getElementById("chat-box");
const messageInput = document.getElementById("message");
const sendBtn = document.getElementById("sendBtn");
const tokensLabel = document.getElementById("tokens");

let cooldownActive = false;
let queuedMessage = null;

let tempMemory = "";
let memoryStored = false;
let sessionTokens = 0;

/* ================= USER SESSION ================= */
let currentUser = sessionStorage.getItem("currentUser") || "";
let sessionUsers = JSON.parse(sessionStorage.getItem("sessionUsers") || "[]");

/* ================= ADMIN DATA (PERSISTENT) ================= */
let adminData = JSON.parse(localStorage.getItem("adminData") || "{}");
adminData.users ||= [];
adminData.totalTokens ||= 0;
adminData.tokenOveruse ||= {};
adminData.leaks ||= {};
saveAdmin();

/* ================= INIT ================= */
(function init(){
    if(currentUser) username.value = currentUser;
    sessionUsers.forEach(addUserOption);
})();

function saveAdmin(){
    localStorage.setItem("adminData", JSON.stringify(adminData));
}

function addUserOption(name){
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    userHistory.appendChild(opt);
}

/* ================= HOME ================= */
function enterChat(){
    home.classList.add("hidden");
    chatUI.classList.remove("hidden");
}

/* ================= USERNAME ================= */
function updateUsername(){
    const name = username.value.trim();
    if(!name) return;

    currentUser = name;
    sessionStorage.setItem("currentUser", name);

    if(!sessionUsers.includes(name)){
        sessionUsers.push(name);
        sessionStorage.setItem("sessionUsers", JSON.stringify(sessionUsers));
        addUserOption(name);
    }

    if(!adminData.users.includes(name)){
        adminData.users.push(name);
        saveAdmin();
    }
}

function selectUsername(){
    currentUser = userHistory.value;
    username.value = currentUser;
    sessionStorage.setItem("currentUser", currentUser);
}

/* ================= CHAT ================= */
function addBubble(type,text){
    const d = document.createElement("div");
    d.className = "bubble " + type;
    d.innerText = text;
    chatBox.appendChild(d);
    chatBox.scrollTop = chatBox.scrollHeight;
}

/* ===== SAVE INTENT ===== */
function detectSaveIntent(t){
    return /(remember this|save this|my name is|i like)/i.test(t);
}

/* ===== LEAK DETECTION (FULL TEXT) ===== */
function detectLeak(text){
    const pass = text.match(/password\s*[:=]\s*(.+)/i);
    if(pass){
        return { type:"Password", value:pass[0] };
    }

    const sensitive = text.match(/[$%^&*]{2,}[A-Za-z0-9]+|[A-Za-z0-9]+[$%^&*]{2,}/);
    if(sensitive){
        return { type:"Sensitive string", value:sensitive[0] };
    }

    return null;
}

async function sendMessage(){
    const msg = messageInput.value.trim();
    if(!msg || !currentUser) return;

    if(cooldownActive){
        queuedMessage = msg;
        addBubble("warning","â³ Please wait, loading answerâ€¦");
        messageInput.value="";
        return;
    }

    cooldownActive = true;
    sendBtn.disabled = true;

    addBubble("user", msg);
    messageInput.value="";

    const used = Math.ceil(msg.length/4);
    sessionTokens += used;
    adminData.totalTokens += used;
    tokensLabel.innerText = sessionTokens;

    if(detectSaveIntent(msg) && !memoryStored){
        tempMemory += msg + "\n";
        memoryStored = true;
        addBubble("warning","ğŸ§  Saved for this session.");
    }

    const leak = detectLeak(msg);
    if(leak){
        adminData.leaks[currentUser] ||= [];
        adminData.leaks[currentUser].push({
            type: leak.type,
            text: leak.value,
            time: new Date().toLocaleString()
        });
        saveAdmin();
        addBubble("warning",`âš ï¸ Sensitive info detected (${leak.type})`);
    }

    addBubble("ai","Typingâ€¦");

    const res = await fetch("/chat",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({message:msg+"\n\nContext:\n"+tempMemory})
    });

    const data = await res.json();
    chatBox.lastChild.remove();
    addBubble("ai", data.reply);

    const rUsed = Math.ceil(data.reply.length/4);
    sessionTokens += rUsed;
    adminData.totalTokens += rUsed;
    tokensLabel.innerText = sessionTokens;

    if(sessionTokens > 1000){
        adminData.tokenOveruse[currentUser] =
            (adminData.tokenOveruse[currentUser] || 0) + 1;
    }

    saveAdmin();

    setTimeout(()=>{
        cooldownActive=false;
        sendBtn.disabled=false;
        if(queuedMessage){
            messageInput.value = queuedMessage;
            queuedMessage = null;
            sendMessage();
        }
    },3000);
}

/* ================= ADMIN PANEL ================= */
function openAdmin(){
    const key = prompt("Admin password:");
    if(key !== "its-laksith") return alert("Denied");

    let html = `
    <h3>Admin Panel</h3>
    <p><b>Total Users:</b> ${adminData.users.length}</p>
    <p><b>Usernames:</b> ${adminData.users.join(", ")}</p>
    <p><b>Total Tokens:</b> ${adminData.totalTokens}</p>

    <h4>Token Overuse</h4><ul>`;
    for(const u in adminData.tokenOveruse){
        html += `<li>${u}: ${adminData.tokenOveruse[u]} times</li>`;
    }
    html += `</ul><h4>Leaks</h4>`;

    for(const u in adminData.leaks){
        html += `<div><b>${u}</b><ul>`;
        adminData.leaks[u].forEach(l=>{
            html += `<li>
                <b>Type:</b> ${l.type}<br>
                <b>Text:</b> <code>${l.text}</code><br>
                <b>Time:</b> ${l.time}
            </li>`;
        });
        html += `</ul></div>`;
    }

    html += `<button onclick="admin.classList.add('hidden')">Close</button>`;
    admin.innerHTML = html;
    admin.classList.remove("hidden");
}

/* ================= UTIL ================= */
function toggleTheme(){document.body.className=document.body.className==="dark"?"light":"dark"}
function openSettings(){settings.classList.remove("hidden")}
function closeSettings(){settings.classList.add("hidden")}
function openCommands(){commands.classList.remove("hidden")}
function closeCommands(){commands.classList.add("hidden")}
function setTextSize(v){document.documentElement.style.fontSize=v+"px"}
function searchChat(){
    const q=search.value.toLowerCase();
    document.querySelectorAll(".bubble").forEach(b=>{
        b.style.opacity=b.innerText.toLowerCase().includes(q)?1:0.3;
    });
}
function clearChat(){chatBox.innerHTML=""}
function exportPDF(){
    const {jsPDF}=window.jspdf;
    const pdf=new jsPDF(); let y=10;
    document.querySelectorAll(".bubble").forEach(b=>{
        pdf.text(b.innerText,10,y); y+=8;
        if(y>280){pdf.addPage(); y=10;}
    });
    pdf.save("chat.pdf");
}
function importPDF(){fileInput.click()}
function startVoice(){
    const r=new webkitSpeechRecognition();
    r.lang="en-US";
    r.start();
    r.onresult=e=>messageInput.value=e.results[0][0].transcript;
}
</script>
</body>
</html>
